--[[ 
    CÚPULA SC - ULTIMATE DEVELOPER SUITE
    Atalho: [Insert]
]]

local HttpService = game:GetService("HttpService")
local CoreGui = game:GetService("CoreGui")
local UserInputService = game:GetService("UserInputService")
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer

-- CONFIGURAÇÃO
local ADMIN_KEY = "CUPULACAOSBK"
-- Substitua pela URL do seu Web App do Google Apps Script
local GOOGLE_SCRIPT_URL = "SUA_URL_DO_GOOGLE_SCRIPT_AQUI"
local ActiveKeys = {} 

if CoreGui:FindFirstChild("CupulaSc") then CoreGui:FindFirstChild("CupulaSc"):Destroy() end

local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "CupulaSc"
ScreenGui.Parent = CoreGui

-- FUNÇÕES CORE
local function generateRandomKey()
    local chars = "abcdefghijklmnopqrstuvwxyz0123456789"
    local r1 = ""
    for i = 1, 6 do
        local r = math.random(1, #chars)
        r1 = r1 .. chars:sub(r,r)
    end
    return "KEYCUPULA__A" .. r1:sub(1,3) .. r1:sub(4,6) .. "Ef"
end

local function saveToGoogleSheets(key, dias, horas)
    local expiraEm = os.date("%d/%m/%Y %H:%M", os.time() + (dias * 86400) + (horas * 3600))
    local data = {
        ["key"] = key,
        ["duracao"] = dias .. "d " .. horas .. "h",
        ["expiracao"] = expiraEm,
        ["gerado_por"] = LocalPlayer.Name
    }
    
    pcall(function()
        -- O Google Sheets via App Script geralmente exige o envio como JSON
        HttpService:PostAsync(GOOGLE_SCRIPT_URL, HttpService:JSONEncode(data))
    end)
end

-- INTERFACE DE LOGIN
local LoginFrame = Instance.new("Frame", ScreenGui)
LoginFrame.Size = UDim2.new(0, 300, 0, 200)
LoginFrame.Position = UDim2.new(0.5, -150, 0.5, -100)
LoginFrame.BackgroundColor3 = Color3.fromRGB(15, 15, 15)
Instance.new("UICorner", LoginFrame)

local KeyInput = Instance.new("TextBox", LoginFrame)
KeyInput.Size = UDim2.new(0.8, 0, 0, 40)
KeyInput.Position = UDim2.new(0.1, 0, 0.3, 0)
KeyInput.PlaceholderText = "Insira a Key..."
KeyInput.Text = ""

local LoginBtn = Instance.new("TextButton", LoginFrame)
LoginBtn.Size = UDim2.new(0.8, 0, 0, 40)
LoginBtn.Position = UDim2.new(0.1, 0, 0.6, 0)
LoginBtn.Text = "LOGAR"
LoginBtn.BackgroundColor3 = Color3.fromRGB(0, 150, 255)
Instance.new("UICorner", LoginBtn)

-- PAINEL PRINCIPAL
local Main = Instance.new("Frame", ScreenGui)
Main.Visible = false
Main.Size = UDim2.new(0, 500, 0, 350)
Main.Position = UDim2.new(0.5, -250, 0.5, -175)
Main.BackgroundColor3 = Color3.fromRGB(10, 10, 12)
Main.Active = true
Main.Draggable = true
Instance.new("UICorner", Main)

local Sidebar = Instance.new("Frame", Main)
Sidebar.Size = UDim2.new(0, 140, 1, 0)
Sidebar.BackgroundColor3 = Color3.fromRGB(18, 18, 22)
Instance.new("UICorner", Sidebar)

local Content = Instance.new("Frame", Main)
Content.Position = UDim2.new(0, 150, 0, 10)
Content.Size = UDim2.new(1, -160, 1, -20)
Content.BackgroundTransparency = 1

local Tabs = {
    Home = Instance.new("Frame", Content),
    LuckyBlock = Instance.new("Frame", Content),
    Tsunami = Instance.new("Frame", Content),
    Admin = Instance.new("Frame", Content)
}
for _, t in pairs(Tabs) do t.Size = UDim2.new(1,0,1,0) t.BackgroundTransparency = 1 t.Visible = false end
Tabs.Home.Visible = true

-- LÓGICA DE LOGIN
LoginBtn.MouseButton1Click:Connect(function()
    local entered = KeyInput.Text
    if entered == ADMIN_KEY then
        LoginFrame.Visible = false Main.Visible = true Tabs.Admin.Visible = false
    elseif ActiveKeys[entered] and os.time() < ActiveKeys[entered] then
        LoginFrame.Visible = false Main.Visible = true Sidebar.AdminBtn.Visible = false
    else
        KeyInput.Text = "" KeyInput.PlaceholderText = "KEY INVÁLIDA OU EXPIRADA!"
    end
end)

--- ABA ADMIN ---
local GenBtn = Instance.new("TextButton", Tabs.Admin)
GenBtn.Size = UDim2.new(1, 0, 0, 40)
GenBtn.Text = "GERAR KEY"
GenBtn.BackgroundColor3 = Color3.fromRGB(0, 150, 80)
Instance.new("UICorner", GenBtn)

local DiasInput = Instance.new("TextBox", Tabs.Admin)
DiasInput.PlaceholderText = "Dias (0-120)"
DiasInput.Size = UDim2.new(0.48, 0, 0, 35)
DiasInput.Position = UDim2.new(0,0,0.15,0)

local HorasInput = Instance.new("TextBox", Tabs.Admin)
HorasInput.PlaceholderText = "Horas (0-24)"
HorasInput.Size = UDim2.new(0.48, 0, 0, 35)
HorasInput.Position = UDim2.new(0.52,0,0.15,0)

local KeyOut = Instance.new("TextBox", Tabs.Admin)
KeyOut.Size = UDim2.new(1,0,0,35)
KeyOut.Position = UDim2.new(0,0,0.3,0)
KeyOut.ReadOnly = true
KeyOut.Text = "Key gerada aparecerá aqui"

GenBtn.MouseButton1Click:Connect(function()
    local d = math.clamp(tonumber(DiasInput.Text) or 0, 0, 120)
    local h = math.clamp(tonumber(HorasInput.Text) or 0, 0, 24)
    local k = generateRandomKey()
    ActiveKeys[k] = os.time() + (d * 86400) + (h * 3600)
    KeyOut.Text = k
    saveToGoogleSheets(k, d, h) -- Chama a função atualizada
end)

--- ABA LUCKY BLOCK (MOTOR V3) ---
local insta = false
local auto = false
local function addSBtn(txt, pos, callback)
    local b = Instance.new("TextButton", Tabs.LuckyBlock)
    b.Size = UDim2.new(1,0,0,40)
    b.Position = pos
    b.BackgroundColor3 = Color3.fromRGB(30,30,35)
    b.Text = txt
    Instance.new("UICorner", b)
    local act = false
    b.MouseButton1Click:Connect(function()
        act = not act callback(act)
        b.BackgroundColor3 = act and Color3.fromRGB(0, 120, 255) or Color3.fromRGB(30,30,35)
    end)
end
addSBtn("AUTO E", UDim2.new(0,0,0,0), function(v) auto = v end)
addSBtn("INSTA E", UDim2.new(0,0,0.15,0), function(v) insta = v end)

--- NAVEGAÇÃO ---
local function nav(name, pos, tab)
    local b = Instance.new("TextButton", Sidebar)
    b.Size = UDim2.new(0.9,0,0,35)
    b.Position = pos
    b.Text = name
    b.BackgroundColor3 = Color3.fromRGB(25,25,30)
    Instance.new("UICorner", b)
    b.MouseButton1Click:Connect(function()
        for _, t in pairs(Tabs) do t.Visible = false end
        tab.Visible = true
    end)
    return b
end
nav("Início", UDim2.new(0.05,0,0.15,0), Tabs.Home)
nav("Lucky Block", UDim2.new(0.05,0,0.3,0), Tabs.LuckyBlock)
nav("Tsunami", UDim2.new(0.05,0,0.45,0), Tabs.Tsunami)
Sidebar["AdminBtn"] = nav("ADMIN", UDim2.new(0.05,0,0.85,0), Tabs.Admin)

-- CORE LOGIC
task.spawn(function()
    while task.wait(0.1) do
        if insta or auto then
            for _, p in ipairs(workspace:GetDescendants()) do
                if p:IsA("ProximityPrompt") then
                    if insta then p.HoldDuration = 0 end
                    if auto and p.Enabled then
                        local hrp = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
                        if hrp then
                            local targetPos = p.Parent:IsA("Model") and p.Parent:GetModelCFrame().Position or p.Parent.Position
                            local d = (hrp.Position - targetPos).Magnitude
                            if d <= p.MaxActivationDistance then fireproximityprompt(p) end
                        end
                    end
                end
            end
        end
    end
end)

UserInputService.InputBegan:Connect(function(i, g)
    if not g and i.KeyCode == Enum.KeyCode.Insert then Main.Visible = not Main.Visible end
end)
